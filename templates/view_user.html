{% extends "base.html" %}
{% block content %}
<div class="container">
    {% if current_user.role == 'admin' %}
        <form method="GET" action="{{ url_for('view_user') }}" class="form-inline mb-3">
            <div class="form-group">
                <label for="user_select" class="mr-2">Select User:</label>
                <select id="user_select" name="user_id" class="form-control" onchange="this.form.submit()">
                    {% for u in all_users %}
                        <option value="{{ u.id }}" {% if u.id == user.id %}selected{% endif %}>{{ u.username }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    {% endif %}
    
    <h2>{{ user.username }}</h2>
    
    <div class="row">
        <!-- User Information -->
        <div class="col-md-6">
            <h3>User Information</h3>
            <ul class="list-group mb-3">
                <li class="list-group-item"><strong>Start Date:</strong> {{ user.start_date }}</li>
                <li class="list-group-item"><strong>Birth Date:</strong> {{ user.birth_date }}</li>
            </ul>
        </div>

        <!-- Bucket Hours -->
        <div class="col-md-6">
            <h3>Bucket Hours</h3>
            <ul class="list-group mb-3">
                <li class="list-group-item"><strong>PTO Bucket Hours:</strong> {{ initial_pto_total }}</li>
                <li class="list-group-item"><strong>PTO Used Hours:</strong> {{ used_pto_hours }}</li>
                <li class="list-group-item"><strong>PTO Hours Remaining:</strong> {{ pto_total }}</li>
                <li class="list-group-item"><strong>Emergency Bucket Hours:</strong> {{ initial_emergency_total }}</li>
                <li class="list-group-item"><strong>Emergency Used Hours:</strong> {{ used_emergency_hours }}</li>
                <li class="list-group-item"><strong>Emergency Hours Remaining:</strong> {{ emergency_total }}</li>
                <li class="list-group-item"><strong>Vacation Bucket Hours:</strong> {{ initial_vacation_total }}</li>
                <li class="list-group-item"><strong>Vacation Used Hours:</strong> {{ used_vacation_hours }}</li>
                <li class="list-group-item"><strong>Vacation Hours Remaining:</strong> {{ vacation_total }}</li>
            </ul>
        </div>
    </div>

    <!-- Time Off History -->
    <h3>Time Off History</h3>
    <form method="GET" action="{{ url_for('view_user', user_id=user.id) }}">
        <div class="form-group">
            <label for="year">Filter by Year</label>
            <select id="year" name="year" class="form-control" onchange="this.form.submit()">
                {% for y in range(2023, datetime.utcnow().year + 1) %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
    </form>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Date</th>
                <th>Hours</th>
                <th>Reason</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for time_off in time_offs %}
                <tr>
                    <td>{{ time_off.date }}</td>
                    <td>{{ time_off.hours }}</td>
                    <td>
                        {% if time_off.reason == 'pto' %}
                            PTO
                        {% elif time_off.reason == 'emergency' %}
                            Emergency
                        {% elif time_off.reason == 'vacation' %}
                            Vacation
                        {% endif %}
                    </td>
                    <td>
                        {% if current_user.role == 'admin' %}
                            <form method="POST" action="{{ url_for('delete_time_off', time_off_id=time_off.id) }}" style="display:inline;">
                                {{ form.hidden_tag() }}
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        {% else %}
                            <button class="btn btn-danger btn-sm" disabled>Delete</button>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Bucket Changes -->
    <h3>Bucket Changes</h3>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Old Value</th>
                <th>New Value</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for change in bucket_changes %}
                <tr>
                    <td>{{ change.date }}</td>
                    <td>{{ change.category }}</td>
                    <td>{{ change.old_value }}</td>
                    <td>{{ change.new_value }}</td>
                    <td>
                        {% if current_user.role == 'admin' %}
                            <form method="POST" action="{{ url_for('delete_bucket_change', bucket_change_id=change.id) }}" style="display:inline;">
                                {{ form.hidden_tag() }}
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        {% else %}
                            <button class="btn btn-danger btn-sm" disabled>Delete</button>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Notes -->
    <h3>Notes</h3>
    <form method="POST" action="{{ url_for('add_note', user_id=user.id) }}">
        {{ note_form.hidden_tag() }}
        <div class="form-group">
            {{ note_form.content.label(class="form-label") }}
            {{ note_form.content(class="form-control") }}
        </div>
        <div class="form-group">
            {{ note_form.submit(class="btn btn-primary") }}
        </div>
    </form>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Date</th>
                <th>Note</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for note in notes %}
                <tr>
                    <td>{{ note.date }}</td>
                    <td>{{ note.content }}</td>
                    <td>
                        {% if current_user.role == 'admin' %}
                            <form method="POST" action="{{ url_for('delete_note', note_id=note.id) }}" style="display:inline;">
                                {{ form.hidden_tag() }}
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        {% else %}
                            <button class="btn btn-danger btn-sm" disabled>Delete</button>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
